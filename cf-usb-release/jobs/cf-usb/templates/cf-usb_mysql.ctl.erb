#!/bin/bash

<% if p("cf-usb.configprovider") == "mysqlConfigProvider" %>

function createMysqlConfig {
  set -e
  /var/vcap/packages/mariadb/mysql -h <%= p("cf-usb.mysql_address") %> -u usb -p<%= p("cf-usb.mysql_password") %> < /var/vcap/jobs/cf-usb/config/usb_mysql_create_db.sql
  /var/vcap/packages/mariadb/mysql -h <%= p("cf-usb.mysql_address") %> -u usb -p<%= p("cf-usb.mysql_password") %> < /var/vcap/jobs/cf-usb/config/usb_mysql_config.sql
  set +e
}


  dbUsb=$(/var/vcap/packages/mariadb/mysql -h <%= p("cf-usb.mysql_address") %> -u usb -p<%= p("cf-usb.mysql_password") %> -e "SHOW DATABASES;" | grep "usb")
  if [ $dbUsb=="usb" ]; then
    tableConfig=$(/var/vcap/packages/mariadb/mysql usb -h <%= p("cf-usb.mysql_address") %> -u usb -p<%= p("cf-usb.mysql_password") %> -e "SHOW TABLES;" | grep "Config")
      <% if p("cf-usb.override") == false %>
      if [ -z $tableConfig ]; then
        createMysqlConfig
      fi
      <% else %>
        createMysqlConfig
      <% end %>
  else
    createMysqlConfig
  fi

pidfile="/var/vcap/sys/run/cf-usb/cf-usb-migrate.pid"

# create log directory if it doesn't exist
[ ! -d /var/vcap/sys/log/cf-usb-migrate/ ] && mkdir -p /var/vcap/sys/log/cf-usb-migrate/

# create the pidfile directory if it doesn't exist
[ ! -d `dirname $pidfile` ] && mkdir -p `dirname $pidfile`

# start cf-usb migration only if there's no other instance running
pidof usb-migrate >/dev/null || \
  {
	#export mysql and consul environment variables and do migration
	export MYSQL_ADDRESS=<%= p("cf-usb.mysql_address") %>:3306
	export MYSQL_DB=usb
	export MYSQL_USER=usb
	export MYSQL_PASSWORD=<%= p("cf-usb.mysql_password") %>
	
	export CONSUL_ADDRESS=127.0.0.1:8500
	
	export OVERWRITE_CONFIG=<%= p("cf-usb.override") %>

	/var/vcap/packages/cf-usb/bin/dbmigrate 1>>/var/vcap/sys/log/cf-usb-migrate/cf-usb.log 2>&1 &
	
	echo $! >$pidfile
  }
  
<% end %>
