#!/bin/bash

set -e

<% if p("cf-usb.configprovider") == "mysqlConfigProvider" %>

function createMysqlConfig {
  /var/vcap/packages/mariadb/mysql -h <%= p("cf-usb.mysql_address") %> -u usb -p<%= p("cf-usb.mysql_password") %> < /var/vcap/jobs/cf-usb/config/usb_mysql_create_db.sql
  /var/vcap/packages/mariadb/mysql -h <%= p("cf-usb.mysql_address") %> -u usb -p<%= p("cf-usb.mysql_password") %> < /var/vcap/jobs/cf-usb/config/usb_mysql_config.sql
}


  dbUsb=$(/var/vcap/packages/mariadb/mysql -h <%= p("cf-usb.mysql_address") %> -u usb -p<%= p("cf-usb.mysql_password") %> -e "SHOW DATABASES;" | grep "usb"  || : )
  if [ $dbUsb=="usb" ]; then
    tableConfig=$(/var/vcap/packages/mariadb/mysql usb -h <%= p("cf-usb.mysql_address") %> -u usb -p<%= p("cf-usb.mysql_password") %> -e "SHOW TABLES;" | grep "Config"  || : )
      <% if p("cf-usb.override") == false %>
      if [ -z $tableConfig ]; then
        createMysqlConfig
      fi
      <% else %>
        createMysqlConfig
      <% end %>
  else
    createMysqlConfig
  fi
<% end %>
