# Universal service broker

[TOC]

## Summary
The cf-usb project implements and exposes the Cloud Foundry [Service Broker API](http://docs.cloudfoundry.org/services/api.html). 

It uses plugins (drivers) to connect to different services.

![cf-usb](https://region-b.geo-1.objects.hpcloudsvc.com/v1/11899734124432/imgs/usb.png)

## Unamaged USB

Unmanaged USB provides provides a limited number of features and implments the basic functionality of a Cloud Foundry Service Broker.

Constraints:
- it does not provide functionality for upgrading drivers, services, plans, etc.
- does not automatically register to the Cloud Controller.
- only `fileConfigProvider` can be used as a configuration provider.
- it does not expose a management API.
- if a `driver` fails to start, the connection between the `driver` and the server cannot be establised or if the configuration/dials schema can not be validated, the USB exists with an exitcode != 0.

### Deployment strategies

#### 1. Cloud Foundry application

The unmanaged USB can be deployed as an app to a Cloud Foundry deploymenet. All the services managed must be external services.

#### 2. fissile

TODO.

## Managed USB

The managed USB provides a management API for configuration and update.

Constraints:
- it can not use `fileConfigProvider` as a configuration provider

###Management API

####Authorization

##### 1. UAA
USB uses UAA as an authorization provider. It requires the `cc_usb_management` OAuth client to be configured with the following properties:
- secret: {clientsecret}
- scope: cloud_controller.write,openid,cloud_controller.read,cloud_controller_service_permissions.read, cloud_controller_service_permissions.write
- authorities: usb.management.admin
- authorized-grant-types: client_credentials 

##### 2. Basic auth
Basic auth can be used when making calls to the USB management API.

#### API Definition
TODO: add api definitions for the management API.

###Deployment strategies

#### 1. Cloud Foundry application

In order to deploy to Cloud Foundry, two apps must be pushed.
- first app exposes the broker API
- secound app exposes the managent API 

#### 2. fissile

TODO:

## Configuration

**cf-usb** works with multiple configuration providers:

###File configuration provider## 
**cf-usb** can take it's configuration from a .json file. The json file format is similar to a standard broker configuration file. 
To start the broker with a file configuration provider you must provide the following cli options:

```sh
 ./usb fileConfigProvider --path {path_to_jsonfile}
```

`dials`

`driver_configs`

### MySQL configuration provider###
The state and the configuration of USB can be stored in a MySQL database


#### Database Schema ###

TODO: add schema

## Drivers

### Driver-USB Relationship


### Folder structure
```
|-- drivers
|   |-- {driver_type}
|       |-- data
|           |-- schemas.go     | Generated by usb Makefile
|       |-- schemas
|           |-- dails.json     | dails JSON schema definition
|           |-- config.json    | driver_config JSON schema definition

```

### Principals

- Each driver call must be represented by an atomic operation.
- USB must be able to validate all incoming CC requests using the driver interface.

### Driver Interface
#### Init
Initializes the driver

**Request** 

| Object | Description |
| :---: | :---: |
| DriverConfig | Information used by the driver to connect to the service |

Example *DriverConfig* for MSSQL

```sh
{  
	"brokerGoSqlDriver":"mssql",
    "brokerMssqlConnection":{  
    	"server":"127.0.0.1",
        "port":"38017",
        "database":"master",
        "user id":"sa",
        "password":"mysapassword"
 }
```

**Response**

| Type | Description |
| :---: | :---: |
| interface{} | *reserved |
| error | Driver Initialization error |



### Ping
Checks if the driver can reach the server.

**Request** 

| Type | Description |
| :---: | :---: |
| string | empty string |


**Response**

| Type | Description |
| :---: | :---: |
| bool | Returns *true* if the driver can reach the server, *false* otherwise |
| error | Service connection error |

### GetDialsSchema

**Request** 

| Type | Description |
| :---: | :---: |
| string | empty string |

**Response**

| Type | Description |
| :---: | :---: |
| string | the json schema for the *dials* supported by the driver |
| error | GetDialsSchema error |

Example schema for MSSQL *dials*
```sh
{
"type": "object",
"properties": {
	"max_dbsize_mb": {
		"type": "integer",
		"minimum": 0
	}
},
"required": ["max_dbsize_mb"]
}
```

### GetConfigSchema

Gets the JSON schema for the *driver_config*

**Request** 

| Type | Description |
| :---: | :---: |
| string | empty string |

**Response**

| Type | Description |
| :---: | :---: |
| string | the json schema for the *driver_config* of the driver |
| error | GetDialsSchema error |

Example schema for MSSQL *driver_config*
```sh
{
  "type": "object",
  "properties": {
    "brokerGoSqlDriver": {
      "type": "string"
    },
    "brokerMssqlConnection": {
      "type": "object",
      "properties": {
        "server": {
          "type": "string"
        },
        "port": {
          "type": "string"
        },
        "database": {
          "type": "string"
        },
        "user id": {
          "type": "string"
        },
        "password": {
          "type": "string"
        }
      }
    }
  },
  "required": [
    "brokerGoSqlDriver",
    "brokerMssqlConnection"
  ]
}
```

### ProvisionInstance
Creates a service instance

**Request**

| Type | Description |
| :---: | :---: |
| ProvisionInstanceRequest | Object containing the *instanceID* and a *dails* object |

Dials are restrictions that can be applied to instances.
Example for MSSQL:
```sh
{
	"max_dbsize_mb": 1500
}
```


**Response**

| Type | Description |
| :---: | :---: |
| bool | *true* if the instance was created. |
| error | Provision Instance error |

### InstanceExists

Checks if the specified service exists.

**Request**

| Type | Description |
| :---: | :---: |
| string | The ID of the instance |

**Response**

| Type | Description |
| :---: | :---: |
| bool | *true* if the instance exists. |
| error | Instance Exists error |

### GenerateCredentials

Generates for the for the specified instance

**Request**

| Type | Description |
| :---: | :---: |
| CredentialsRequest | Object containing the *instanceID* and the *credentialsID* |

**Response**

| Type | Description |
| :---: | :---: |
| interface{} | Connection information for the specified service |
| error | GenerateCredentials error |

Example for MSSQL:

```sh
type MssqlCredentials struct {
	Hostname         string `json:"hostname"`
	Port             int    `json:"port"`
	Name             string `json:"name"`
	Username         string `json:"username"`
	Password         string `json:"password"`
	ConnectionString string `json:"connectionString"`
}
```

### CredentialsExist

Checks if the specified credentials exist.

**Request**

| Type | Description |
| :---: | :---: |
| CredentialsRequest | Object containing the *instanceID* and the *credentialsID* |
**Response**

| Type | Description |
| :---: | :---: |
| bool | *true* if the credentials exist |
| error | CredentialsExists error |

### RevokeCedentials

Revoke the credentials of the specified *credentialsID*

**Request**

| Type | Description |
| :---: | :---: |
| CredentialsRequest | Object containing the *instanceID* and the *credentialsID* |
**Response**

| Type | Description |
| :---: | :---: |
| interface{} | *reserved |
| error | RevokeCedentials error |


### DeprovisionInstance

**Request**

Deprovisions the instance having the specified *instanceID*

| Type | Description |
| :---: | :---: |
| string | *instanceID* |

**Response**

| Type | Description |
| :---: | :---: |
| interface{} | *reserved |
| error | DeprovisionInstance error |



## Building and running

### Requirements:
- Go 1.4

### Building:
```sh
mkdir -p $GOPATH/src/github.com/hpcloud
cd $GOPATH/src/github.com/hpcloud
git clone git@github.com:hpcloud/cf-usb.git

make tools
godep restore
make
```
### Running:
To run one or more drivers, you need to copy the driver executable to *{path_to_usb}/drivers/*
```sh
./usb {fileConfigProvider} --{path} {path_to_jsonfile}
```